@typeparam TItem
@implements IDisposable

<div class="search-pagination-container" role="search" aria-label="Búsqueda con paginación">
    <!-- Search Input -->
    <div class="mb-3">
        <label for="search-input" class="form-label visually-hidden">Búsqueda</label>
        <div class="input-group">
            <input type="text"
                   id="search-input"
                   class="form-control"
                   placeholder="@Placeholder"
                   value="@_searchText"
                   @oninput="OnSearchInputChanged"
                   aria-label="@Placeholder"
                   aria-describedby="search-clear-btn" />
            @if (!string.IsNullOrEmpty(_searchText))
            {
                <button type="button"
                        id="search-clear-btn"
                        class="btn btn-outline-secondary"
                        @onclick="ClearSearch"
                        aria-label="Limpiar búsqueda">
                    <span aria-hidden="true">&times;</span>
                </button>
            }
        </div>
    </div>

    <!-- Loading Overlay -->
    @if (_isLoading)
    {
        <div class="position-relative" aria-live="polite" aria-busy="true">
            <div class="d-flex justify-content-center align-items-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <span class="ms-2">Cargando...</span>
            </div>
        </div>
    }
    else
    {
        <!-- Error Alert -->
        @if (_errorMessage != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert" aria-live="assertive">
                <strong>Error:</strong> @_errorMessage
                <button type="button" class="btn-close" @onclick="DismissError" aria-label="Cerrar"></button>
            </div>
        }

        <!-- Results -->
        <div aria-live="polite">
            @if (_searchResult != null && _searchResult.Items.Any())
            {
                <div class="results-container">
                    @foreach (var item in _searchResult.Items)
                    {
                        @ItemTemplate(item)
                    }
                </div>

                <!-- Pagination -->
                <nav aria-label="Paginación de resultados">
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="pagination-info" aria-label="Información de página">
                            <span>Página @_currentPage de @_totalPages (@_searchResult.TotalCount resultados totales)</span>
                        </div>
                        <ul class="pagination mb-0">
                            <li class="page-item @(_currentPage <= 1 ? "disabled" : "")">
                                <button class="page-link"
                                        @onclick="GoToPreviousPage"
                                        disabled="@(_currentPage <= 1)"
                                        aria-label="Página anterior">
                                    &laquo; Anterior
                                </button>
                            </li>
                            <li class="page-item @(_currentPage >= _totalPages ? "disabled" : "")">
                                <button class="page-link"
                                        @onclick="GoToNextPage"
                                        disabled="@(_currentPage >= _totalPages)"
                                        aria-label="Página siguiente">
                                    Siguiente &raquo;
                                </button>
                            </li>
                        </ul>
                    </div>
                </nav>
            }
            else if (_searchResult != null && !_searchResult.Items.Any())
            {
                <div class="alert alert-info" role="status" aria-label="Sin resultados">
                    <span class="bi bi-info-circle me-2"></span>
                    No se encontraron resultados para su búsqueda.
                </div>
            }
        </div>
    }
</div>

@code {
    /// <summary>
    /// Template for rendering each item in the search results.
    /// </summary>
    [Parameter]
    public RenderFragment<TItem> ItemTemplate { get; set; } = default!;

    /// <summary>
    /// Function to fetch search results. Receives SearchRequest, returns SearchResult.
    /// </summary>
    [Parameter]
    public Func<SearchRequest, CancellationToken, Task<SearchResult<TItem>>> DataProvider { get; set; } = default!;

    /// <summary>
    /// Placeholder text for the search input.
    /// </summary>
    [Parameter]
    public string Placeholder { get; set; } = "Buscar...";

    /// <summary>
    /// Number of items per page.
    /// </summary>
    [Parameter]
    public int PageSize { get; set; } = 10;

    /// <summary>
    /// Debounce delay in milliseconds.
    /// </summary>
    [Parameter]
    public int DebounceDelay { get; set; } = 300;

    /// <summary>
    /// Whether to automatically load data on initialization.
    /// </summary>
    [Parameter]
    public bool LoadOnInit { get; set; } = true;

    private string _searchText = string.Empty;
    private int _currentPage = 1;
    private int _totalPages = 0;
    private bool _isLoading = false;
    private string? _errorMessage = null;
    private SearchResult<TItem>? _searchResult = null;
    private CancellationTokenSource? _debounceCts = null;
    private CancellationTokenSource? _searchCts = null;

    protected override void OnParametersSet()
    {
        if (DataProvider == null)
        {
            throw new InvalidOperationException("DataProvider parameter is required.");
        }

        if (ItemTemplate == null)
        {
            throw new InvalidOperationException("ItemTemplate parameter is required.");
        }

        if (PageSize <= 0)
        {
            throw new InvalidOperationException("PageSize must be greater than zero.");
        }
    }

    protected override async Task OnInitializedAsync()
    {
        if (LoadOnInit)
        {
            await ExecuteSearch();
        }
    }

    private async Task OnSearchInputChanged(ChangeEventArgs e)
    {
        _searchText = e.Value?.ToString() ?? string.Empty;
        _currentPage = 1; // Reset to first page on new search

        // Cancel any pending debounce
        _debounceCts?.Cancel();
        _debounceCts?.Dispose();
        _debounceCts = new CancellationTokenSource();

        try
        {
            // Debounce delay
            await Task.Delay(DebounceDelay, _debounceCts.Token);

            // Execute search after debounce
            await ExecuteSearch();
        }
        catch (OperationCanceledException)
        {
            // Debounce was cancelled - expected behavior
        }
    }

    private async Task ExecuteSearch()
    {
        // Cancel any previous search
        _searchCts?.Cancel();
        _searchCts?.Dispose();
        _searchCts = new CancellationTokenSource();
        var currentToken = _searchCts.Token;

        _isLoading = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            var request = new SearchRequest
            {
                Text = _searchText,
                Page = _currentPage,
                PageSize = PageSize
            };

            var result = await DataProvider(request, currentToken);

            // Check if this request was cancelled
            currentToken.ThrowIfCancellationRequested();

            _searchResult = result;
            _totalPages = result.GetTotalPages(PageSize);
        }
        catch (OperationCanceledException)
        {
            // Search was cancelled - expected behavior, don't update state
            return;
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            _searchResult = null;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ClearSearch()
    {
        _searchText = string.Empty;
        _currentPage = 1;
        StateHasChanged(); // Update UI immediately for better user feedback
        await ExecuteSearch();
    }

    private async Task GoToPreviousPage()
    {
        if (_currentPage > 1)
        {
            _currentPage--;
            await ExecuteSearch();
        }
    }

    private async Task GoToNextPage()
    {
        if (_currentPage < _totalPages)
        {
            _currentPage++;
            await ExecuteSearch();
        }
    }

    private void DismissError()
    {
        _errorMessage = null;
    }

    public void Dispose()
    {
        _debounceCts?.Cancel();
        _debounceCts?.Dispose();
        _searchCts?.Cancel();
        _searchCts?.Dispose();
    }
}
